---
title: "CLIMDEX trends"
author: "Marcela Alfaro CÃ³rdoba"
date: "2/7/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
```

## Introduction

This is a report that describes how to calculate the trend significance of each of the precipitation and temperature CLIMDEX indexes, for yearly averages (yearly) and also by using a time series constructed using one month per year for all 12 months (the label monthly). The summary of the original data is the following:

```{r summary, echo=FALSE, message=FALSE, warning=FALSE}
load("data_proc/data_prec_month.Rdata")
SPM<-length(unique(datos_prec$station))
IPM<-names(datos_prec)[-c(1:3)]
rm(datos_prec)
rm(latlonprec)

load("data_proc/data_temp_month.Rdata")
STM<-length(unique(datos_temp$station))
ITM<-names(datos_temp)[-c(1:3)]
rm(datos_temp)
rm(latlontemp)

load("data_proc/data_prec_year.Rdata")
SPY<-length(unique(datos$station))
IPY<-names(datos)[-c(1:2)]
rm(datos)
rm(locations)

load("data_proc/data_temp_year.Rdata")
STY<-length(unique(datos$station))
ITY<-names(datos)[-c(1:2)]
rm(datos)
rm(locations)

table <- rbind(c("Index Variable","Time Domain", 
         "Test", "N of indexes", "N stations"),
       c("Precipitation", "Monthly", "Global and Local",
         paste(length(IPM),"(-2)"),SPM),
       c("Precipitation", "Yearly", "Global and Local",length(IPY),SPY),
       c("Temperature", "Monthly", "Global and Local",
         paste(length(ITM),"(-1)"),STM),
       c("Temperature", "Yearly", "Global and Local",
         paste(length(ITY),"(-2)"),STY))

knitr::kable(table)

# print("Temperature, Monthly:")
# print(ITM)
# 
# print("Temperature, Yearly:")
# print(ITY)
# 
# print("Precipitation, Monthly:")
# print(IPM)
# 
# print("Precipitation, Yearly:")
# print(IPY)
```

  * **Precipitation**:  CDD (consecutive dry days), CWD (consecutive wet days), PRCPTOT (annual total PRCP in wet days), R10mm (number of heavy precipitation days), R20mm (number of very heavy precipitation days), R95p (very wet days in mm), R99p (extremely wet days in mm, a lot of 0s), RX1day (max 1-day precipitation amount in mm), RX5day (max 5-day precipitation amount in mm), SDII (simple daily intensity index in mm/day a lot of 0s). 32 years (1979-2010), 10 indices.
  
  * **Temperature**:  CSDI (annual count of days with at least 6 consecutive days when TN < 10th percentile, 0s for all locations and years),  DTR (Daily temperature range), TN10p (Percentage of days when TN < 10th percentile), TN90p (Percentage of days when TN > 90th percentile), TNn (Minimum value of daily minimum temperature), TNx (Maximum value of daily minimum temperature), TX10p (Percentage of days when TX < 10th percentile), TX90p (Percentage of days when TN > 90th percentile), TXn (Minimum value of daily maximum temperature), TXx (Maximum value of daily maximum temperature), WSDI (annual count of days with at least 6 consecutive days when TX > 90th percentile, 0s for all locations and years). 35 years (1970-2004), 11 indices
  
Source: [https://www.climdex.org/learn/](https://www.climdex.org/learn/)

## Methods

### Local Test

A permutation test was calculated using the Mann Kendall S as statistic. The steps to perform the test for each of the indexes were the following:

1. Create 100 different sets of permutations from the time domain. The set number 101 will be the correct order. The statistic calculated with the last set will be called *observed S*.

2. For each location $j$, a $101$ time series ($X_t$) will be corrected for temporal autocorrelation. In order to do this, the autocorrelation $\hat{r}$ is calculated in each of the time series, and then it is used in: $Y_t = X_t - \hat{r}X_{t-1}$.

3. Once the series are corrected, the Mann Kendall $S$ statistic is calculated for each location $j$, and permutation $k$. 

4. The permutation quantiles ($0.025, 0.975$) are calculated for each location and then, the *observed S* is compared against this interval.

### Global Test

Similarly, a permutation test was calculated using the maximum of the Mann Kendall S as statistic. The steps to perform the test for each of the indexes were the following:

1. Create 100 different sets of permutations from the time domain. The set number 101 will be the correct order. The statistic calculated with the last set will be called *observed S*.

2. For each location $j$, a $101$ time series ($X_t$) will be corrected for temporal autocorrelation. In order to do this, the autocorrelation $\hat{r}$ is calculated in each of the time series, and then it is used in: $Y_t = X_t - \hat{r}X_{t-1}$.

3. Once the series are corrected, the Mann Kendall $S$ statistic is calculated for each location $j$, and permutation $k$. Then, the maximum of each permutation field is recorded and labeled as $max(S)$

4. The permutation quantiles ($0.025, 0.975$) are calculated for each field and then, the *observed max(S)* is compared against this interval.

## Results

### Local Tests
**Precipitation, yearly**

CDD (consecutive dry days)
![](maps_prec_year_panel/prec_year_index1.png)
CWD (consecutive wet days)
![](maps_prec_year_panel/prec_year_index2.png)
PRCPTOT (annual total PRCP in wet days)
![](maps_prec_year_panel/prec_year_index3.png)
R10mm (number of heavy precipitation days)
![](maps_prec_year_panel/prec_year_index4.png)
R20mm (number of very heavy precipitation days)
![](maps_prec_year_panel/prec_year_index5.png)
R95p (very wet days in mm) 
![](maps_prec_year_panel/prec_year_index6.png)
R99p (extremely wet days in mm, a lot of 0s)  
![](maps_prec_year_panel/prec_year_index7.png)
RX1day (max 1-day precipitation amount in mm) 
![](maps_prec_year_panel/prec_year_index8.png)
RX5day (max 5-day precipitation amount in mm)  
![](maps_prec_year_panel/prec_year_index9.png)
SDII (simple daily intensity index in mm/day) 
![](maps_prec_year_panel/prec_year_index10.png)
  
**Temperature, yearly**

DTR (Daily temperature range)  
![](maps_temp_year_panel/temp_year_index2.png)
TN10p (Percentage of days when TN < 10th percentile)  
![](maps_temp_year_panel/temp_year_index3.png)
TN90p (Percentage of days when TN > 90th percentile)
![](maps_temp_year_panel/temp_year_index4.png)
TNn (Minimum value of daily minimum temperature)
![](maps_temp_year_panel/temp_year_index5.png)
TNx (Minimum value of daily maximum temperature)
![](maps_temp_year_panel/temp_year_index6.png)
TX10p (Percentage of days when TX < 10th percentile)
![](maps_temp_year_panel/temp_year_index7.png)
TX90p (Percentage of days when TN > 90th percentile)
![](maps_temp_year_panel/temp_year_index8.png)
TXn (Minimum value of daily maximum temperature)
![](maps_temp_year_panel/temp_year_index9.png)
TXx (Maximum value of daily maximum temperature)
![](maps_temp_year_panel/temp_year_index10.png)


### Global Test

**Precipitation, yearly**
```{r echo=FALSE}
load("data_proc/tab_global_year_prec.Rdata")
tab_global_year_prec$trend <- c("+","-","+","+","+","+","+","+","+","+")
kable(tab_global_year_prec)
```

**Temperature, yearly**
```{r echo=FALSE}
load("data_proc/tab_global_year_temp.Rdata")
tab_global_year_temp$trend <- c("+","-","+","+","+","-","+","+","+")
kable(tab_global_year_temp)
```
